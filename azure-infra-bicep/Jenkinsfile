@Library('shared-lib') _

pipeline {
    agent any

    options {
        buildDiscarder(logRotator(daysToKeepStr: '60'))
        timeout(time: 60, unit: 'MINUTES')
        ansiColor('xterm')
        disableConcurrentBuilds()
    }

    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['dev', 'prod'],
            description: 'Select the target environment'
        )
        choice(
            name: 'SERVICE_NAME',
            choices: [
                'Jenkins-vm',
                'Matching-Service',
                'Matching-Service-QA-Backup',
                'Boomi_Integration',
                'RHELDevQa',
                'RedhatServerUAT',
                'keyvault',
                'storage',
                'network',
                'aks'
            ],
            description: 'Select the service to deploy'
        )
        booleanParam(
            name: 'DEPLOY',
            defaultValue: false,
            description: 'Run actual deployment (skip = What-If only)?'
        )
        booleanParam(
            name: 'DESTROY',
            defaultValue: false,
            description: 'Destroy the selected infrastructure? (irreversible)'
        )
    }

    environment {
        AZURE_DEV_RG  = "CODA_RG"
        AZURE_PROD_RG = "CODA-PROD-RG"
    }

    stages {

        stage('Init') {
            steps {
                script {
                    wrap([$class: 'BuildUser']) {
                        buildUser = env.BUILD_USER ?: 'Unknown'
                    }

                    echo "‚úÖ Initialized by ${buildUser}"
                    echo "üåç Environment: ${params.ENVIRONMENT}"
                    echo "‚öôÔ∏è Service: ${params.SERVICE_NAME}"

                    // Securely set subscription and resource group
                    if (params.ENVIRONMENT == 'dev') {
                        withCredentials([string(credentialsId: 'azure-dev-sub-id', variable: 'DEV_SUB')]) {
                            env.SUBSCRIPTION_ID = DEV_SUB
                            env.RESOURCE_GROUP  = env.AZURE_DEV_RG
                        }
                    } else {
                        withCredentials([string(credentialsId: 'azure-prod-sub-id', variable: 'PROD_SUB')]) {
                            env.SUBSCRIPTION_ID = PROD_SUB
                            env.RESOURCE_GROUP  = env.AZURE_PROD_RG
                        }
                    }

                    echo "üîó Subscription and Resource Group configured securely."
                }
            }
        }

        stage('Checkout IaC Code') {
            steps {
                cleanWs()
                script {
                    echo "üì¶ Cloning IaC repo from Bitbucket..."
                    git branch: 'main',
                        // credentialsId: 'b8e7dce4-8ee0-4a83-b21f-a7f7ccfb20f2',
                        url: "https://github.com/Dineshkundo/azure-infra-bicep.git"

                    echo "‚úÖ Repository cloned successfully."
                }
            }
        }

        stage('Azure Login') {
            steps {
                echo "üîë Authenticating to Azure (Managed Identity)..."
                withEnv(["AZURE_SUB=$SUBSCRIPTION_ID"]) {
                    sh '''
                        set +x
                        az login --identity --output none
                        az account set --subscription "$AZURE_SUB"
                        set -x
                    '''
                }
            }
        }

        stage('What-If Analysis') {
            steps {
                script {
                    def paramFile    = "azure-infra-bicep/parameters/${params.ENVIRONMENT}.${params.SERVICE_NAME}.json"
                    def templateFile = "azure-infra-bicep/main.bicep"

                    if (!fileExists(paramFile)) {
                        error("‚ùå Parameter file not found: ${paramFile}")
                    }

                    echo "üîÆ Running Azure What-If for ${params.SERVICE_NAME}..."
                    sh """
                        set +x
                        az deployment group what-if \
                          --resource-group "$RESOURCE_GROUP" \
                          --template-file "${templateFile}" \
                          --parameters @"${paramFile}" \
                          --mode Incremental \
                          --output table
                        set -x
                    """
                }
            }
        }

        stage('Confirm Deployment') {
            when { expression { params.DEPLOY == true } }
            steps {
                input message: "‚ö†Ô∏è You are about to deploy to '${params.ENVIRONMENT.toUpperCase()}' for service '${params.SERVICE_NAME}'. Confirm to proceed?"
            }
        }

        stage('Deploy Infrastructure') {
            when { expression { params.DEPLOY == true } }
            steps {
                script {
                    def paramFile    = "azure-infra-bicep/parameters/${params.ENVIRONMENT}.${params.SERVICE_NAME}.json"
                    def templateFile = "azure-infra-bicep/main.bicep"
                    
                    // Fetch SSH key from Key Vault
                    SSH_KEY = sh(
                        script: "az keyvault secret show --vault-name CODADEV --name sshPublicKey --query value -o tsv",
                        returnStdout: true
                    ).trim()

                    // Inject SSH key dynamically into vmConfig
                    sh """
                        jq --arg sshKey "$SSH_KEY" '.parameters.vmConfig.value.sshPublicKey = \$sshKey' \
                        $paramFile > ${paramFile}.tmp && mv ${paramFile}.tmp $paramFile
                    """

                    echo "üîë SSH key injected into parameters for deployment."
                    echo "üöÄ Deploying ${params.SERVICE_NAME} to ${params.ENVIRONMENT}..."
                    sh """
                        az deployment group create \
                          --resource-group "$RESOURCE_GROUP" \
                          --template-file "${templateFile}" \
                          --parameters @"${paramFile}" \
                          --mode Incremental \
                          --only-show-errors 
                    """
                }
            }
        }

        stage('Confirm Destruction') {
            when { expression { params.DESTROY == true } }
            steps {
                input message: "‚ö†Ô∏è You are about to DESTROY infrastructure. Confirm to proceed?"
            }
        }

        stage('Destroy Infrastructure') {
            when { expression { params.DESTROY } }
            steps {
                script {
                    echo "üí£ Preparing to destroy '${params.SERVICE_NAME}' (${params.ENVIRONMENT})..."

                    def paramFile = "azure-infra-bicep/parameters/${params.ENVIRONMENT}.${params.SERVICE_NAME}.json"
                    if (!fileExists(paramFile)) {
                        error("‚ùå Parameter file not found: ${paramFile}")
                    }

                    // Extract tag values
                    def envTag      = sh(script: "jq -r '.parameters.tagSuffix.value' ${paramFile}", returnStdout: true).trim()
                    def svcTag      = sh(script: "jq -r '.parameters.serviceName.value' ${paramFile}", returnStdout: true).trim()
                    def createdByTag = sh(script: "jq -r '.parameters.createdBy.value' ${paramFile}", returnStdout: true).trim()

                    echo "üîç Using tags ‚Üí environment='${envTag}', serviceName='${svcTag}', createdBy='${createdByTag}'"

                    // Step 1: Show matching resources
                    sh """
                        az resource list --resource-group "$RESOURCE_GROUP" \
                          --query "[?tags.environment=='${envTag}' && tags.serviceName=='${svcTag}' && tags.createdBy=='${createdByTag}'].[name,type,location]" \
                          -o table || true
                    """

                    // Step 2: Confirm deletion for prod
                    if (envTag.toLowerCase() == "prod") {
                        input message: "‚ö†Ô∏è PRODUCTION WARNING: Confirm deletion of all '${svcTag}' resources in '${envTag}'?"
                    } else {
                        echo "üü¢ Auto-confirmed for non-prod environment (${envTag})."
                    }

                    // Step 3: Collect IDs of resources to delete
                    def resourceIds = sh(
                        script: """
                            az resource list --resource-group "$RESOURCE_GROUP" \
                              --query "[?tags.environment=='${envTag}' && tags.serviceName=='${svcTag}' && tags.createdBy=='${createdByTag}'].id" \
                              -o tsv
                        """,
                        returnStdout: true
                    ).trim()

                    if (!resourceIds) {
                        echo "‚úÖ No matching tagged resources found ‚Äî nothing to delete."
                        return
                    }

                    // Step 4: Delete resources safely
                    echo "üî• Deleting resources tagged with serviceName='${svcTag}'..."
                    sh """
                        echo "${resourceIds}" | xargs -r -I {} az resource delete --ids {} --only-show-errors
                    """

                    echo "‚úÖ All tagged resources for '${svcTag}' successfully deleted."
                }
            }
        }
    }

    post {
        always {
            echo "üßπ Cleaning workspace..."
            cleanWs()
        }
    }
}
